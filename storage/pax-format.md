​	PAX（Partition Attributes Across）是一种面向**列的存储布局优化技术**，它介于传统的行存储（NSM, N-ary Storage Model）和列存储（DSM, Decomposition Storage Model）之间，被提出是为了提高缓存利用率和减少 CPU cache miss。

## 背景

传统的两种存储方式：

**行存储（NSM）**：NSM 适合 OLTP 工作负载。因为在 OLTP 负载中，查询更有可能访问整个记录（对整个记录进行增删改查）。

- 一行数据的所有列连续存储
- 优点：适合读取整行（OLTP）
- 缺点：当只需要读取某几列时，仍会将整行读入缓存，浪费内存带宽和 cache

```
     Col1 Col2 Col3                   Page          
    ┌─────────────┬─┐        ┌──────────┬──────────┐
Row1│ a1   b1   c1│ │        │PageHeader│ a1 b1 c1 │
    ├─────────────┤ │        ├────────┬─┴──────┬───┤
Row2│ a2   b2   c2│ │        │a2 b2 c2│a3 b3 c3│.. │
    ├─────────────┤ │        ├────────┴────────┴───┤
Row3│ a3   b3   c3│ │        │...                  │
    ├─────────────┘ │        ├─────────────────────┤
... │ ..   ..   ..  │        │...                  │
... │ ..   ..   ..  │        └─────────────────────┘
    │               │                               
RowN│ an   bn   cn  │                               
    └───────────────┘
```

**列存储（DSM）**：DSM 适合 OLAP 工作负载，因为 OLAP 负载中往往会对表属性的一个子集执行扫描和计算。

- 每一列单独存储
- 优点：只读需要的列时非常高效（OLAP）
- 缺点：读取多列组合时，需要多次跳转，可能增加 CPU 访问延迟

```
                                 File/Block       
     Col1 Col2 Col3        ┌─────────────────────┐
    ┌────┬────┬────┬┐      │ Header              │
Row1│ a1 │ b1 │ c1 ││      ├─────────────────────┤
    │    │    │    ││      │a1 a2 a3 ......... an│
Row2│ a2 │ b2 │ c2 ││      └─────────────────────┘
    │    │    │    ││                             
Row3│ a3 │ b3 │ c3 ││      ┌─────────────────────┐
    │    │    │    ││      │ Header              │
    │  . │....│.   ││      ├─────────────────────┤
... │    │    │    ││      │b1 b2 b3 ......... bn│
... │ .. │ .. │ .. ││      └─────────────────────┘
RowN│ an │ bn │ cn ││                             
    └────┴────┴────┴┘      ┌─────────────────────┐
                           │ Header              │
                           ├─────────────────────┤
                           │c1 c2 c3 ......... cn│
                           └─────────────────────┘
```



**PAX** 就是要在两者之间找一个折中点。

## PAX 的基本思想

PAX 以 **页（page/block）** 为单位，将一页数据分为两个层次：

- **Page Level**（外层）：依旧像 NSM 那样以 page 为单位管理存储。
- **Mini-Page Level**（内层）：在 page 内，按列存储，每一列形成一个 **mini-page**，存放该页所有行在该列上的值。

换句话说：

- **跨页** 依旧是行导向（按 tuple 分配 page）
- **页内** 是列导向（每一列一个小段）
- 如果表中有变长列（如 `TEXT`, `VARCHAR`）：
    - 固定长度列依然能直接连续存放在 mini-page
    - 变长列 mini-page 存放的是指向变长数据区域的指针（偏移量）
    - 变长数据区域通常在 page 尾部集中存放，和普通行存储类似

```
+--------------------------------------------------+
|                  数据页（Page）                  |
|  (Page Header)                                    |
+--------------------------------------------------+
|                Mini-Page for Col A               |
|  A0  A1  A2  A3  A4  ...  A(N)                   |
+--------------------------------------------------+
|                Mini-Page for Col B               |
|  B0  B1  B2  B3  B4  ...  B(N)                   |
+--------------------------------------------------+
|                Mini-Page for Col C               |
|  C0  C1  C2  C3  C4  ...  C(N)                   |
+--------------------------------------------------+
```

## 优势

1. **减少 cache miss**
     当查询只用到部分列时，只会把相关 mini-page 的数据加载到 CPU cache，避免无用列的搬运。

2. **保持良好行访问性能**
     因为数据仍以 page 为最小 I/O 单位，不像 DSM 那样需要多列拼装。

3. **无需改变现有页管理逻辑**
     PAX 只影响页内部的存储布局，对缓冲管理、磁盘分配等外层模块几乎透明。